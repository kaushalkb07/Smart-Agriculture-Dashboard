{% extends 'base.html' %}

{% block body %}
<h2 class="container">Sign In</h2>
<!-- Sign-in form with JS-based JWT authentication -->
<form id="login-form" class="container">
    {% csrf_token %}
    <div class="form-group">
        <label for="inputUsername">Username</label>
        <input name="loginusername" type="text" class="form-control" id="inputUsername" aria-describedby="emailHelp"
            placeholder="Enter Username" required autofocus>
        <small id="emailHelp" class="form-text text-muted">We'll never share your username with anyone else.</small>
    </div>
    <div class="form-group">
        <label for="inputPassword">Password</label>
        <input name="loginpassword" type="password" class="form-control" id="inputPassword" placeholder="Password"
            required>
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
</form>

<!-- Registration link -->
<div class="form-group container mt-2">
    <label>Not a registered user? <a href="/user_signup">Sign Up</a></label>
</div>

<!-- Error message display -->
<div id="error-message" class="container mt-2 text-danger"></div>

<!-- JavaScript for JWT authentication -->
<script>
    document.getElementById('login-form').addEventListener('submit', async function (event) {
        event.preventDefault();  // Prevent default form submission
    
        const username = document.getElementById('inputUsername').value;
        const password = document.getElementById('inputPassword').value;
    
        // Send POST request to JWT token endpoint
        const response = await fetch('/api/token/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                username: username,
                password: password
            })
        });
    
        const data = await response.json();
    
        // Logging to check if tokens are stored and redirection logic is reached
        console.log('Response Data:', data);
    
        if (response.ok) {
            // Save token in localStorage
            localStorage.setItem('access_token', data.access);
            localStorage.setItem('refresh_token', data.refresh);
    
            console.log('Access Token:', data.access);
            console.log('Refresh Token:', data.refresh);
            console.log('Redirecting to dashboard...');
    
            // Redirect to the dashboard
            window.location.href = 'http://localhost:8000/';
        } else {
            // Show error message if login fails
            document.getElementById('error-message').innerText = 'Invalid username or password';
        }
    });
    
    
</script>
{% endblock body %}
